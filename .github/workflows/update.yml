name: Update MP Earnings

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install pandas requests
      - run: python scraper.py
      - name: Check for Reform/Lowe updates
        run: |
          python << 'EOF'
          import sqlite3
          import pandas as pd
          from datetime import datetime, timedelta

          conn = sqlite3.connect('data/mp_earnings.db')
          yesterday = (datetime.now() - timedelta(days=1)).isoformat()
          
          new = pd.read_sql_query("""
              SELECT member, category, value, summary 
              FROM interests 
              WHERE first_seen > ? 
              AND (party = 'reform' OR member LIKE '%Lowe%')
          """, conn, params=(yesterday,))
          
          if len(new) > 0:
              print("ðŸš¨ NEW REFORM/LOWE INTERESTS:")
              for _, row in new.iterrows():
                  val = f"Â£{row['value']:,.0f}" if pd.notna(row['value']) else "N/A"
                  print(f"::warning::{row['member']} - {val} - {row['category']}")
          else:
              print("âœ… No new Reform/Lowe interests")
          EOF
      - run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add -A
          git diff --staged --quiet || git commit -m "Auto-update $(date +'%Y-%m-%d')"
          git push
