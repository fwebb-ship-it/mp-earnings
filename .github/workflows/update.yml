name: Update MP Earnings

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install pandas requests
      - name: Run scraper and check for alerts
        run: |
          python scraper.py
          python << 'EOF'
          import sqlite3
          import pandas as pd
          from datetime import datetime, timedelta

          conn = sqlite3.connect('data/mp_earnings.db')
          yesterday = (datetime.now() - timedelta(days=1)).isoformat()
          
          # Check for new Reform or Rupert Lowe entries
          new = pd.read_sql_query("""
              SELECT member, category, value, summary 
              FROM interests 
              WHERE first_seen > ? 
              AND (party = 'reform' OR member LIKE '%Lowe%')
          """, conn, params=(yesterday,))
          
          if len(new) > 0:
              print("::warning::NEW REFORM/LOWE INTERESTS DETECTED")
              for _, row in new.iterrows():
                  print(f"  - {row['member']}: Â£{row['value']} ({row['category']})")
              with open('ALERT.txt', 'w') as f:
                  f.write(f"New interests detected on {datetime.now().strftime('%Y-%m-%d')}:\n\n")
                  for _, row in new.iterrows():
                      f.write(f"{row['member']}: Â£{row['value']}\n{row['summary']}\n\n")
          EOF
      - name: Send email alert
        if: hashFiles('ALERT.txt') != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "ðŸš¨ New MP Interest: Reform/Lowe"
          body: file://ALERT.txt
          to: ${{ secrets.ALERT_EMAIL }}
          from: MP Earnings Bot
      - run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add -A
          git diff --staged --quiet || git commit -m "Auto-update $(date +'%Y-%m-%d')"
          git push
